<script>
  (function() {
    'use strict';

    /* Ensures the behavior namespace is created */
    window.PxAppBehavior = (window.PxAppBehavior || {});

    /**
     *
     *
     * @polymerBehavior PxAppBehavior.AssetSelectable
     */
    PxAppBehavior.AssetSelectable = {
      properties: {
        /**
         * A reference to the currently selected item. Use this property to set the
         * selected item directly. The object passed to this property must be a
         * direct reference to one of the `items` objects. Changing this property
         * will automatically update the `selectedRoute`.
         *
         * See `selectedRoute` for an alternative way to select items.
         */
        selected: {
          type: Object,
          notify: true,
          value: function() {
            return this.multiSelect ? [] : null;
          },
          observer: '_assetSelectedByReference'
        },

        /**
         * The route to the selected item as an array of strings. Use this property
         * to set the selected item by route, or to bind to updates when the
         * selected item is changed. Changing this property will automatically
         * update the `selected` item.
         *
         * The route array starts at the top of the graph and ends with the selected
         * item. Each route entry is a string that corresponds to the unique ID
         * of an item. The item property this unique ID will be taken from can be
         * configured with the `key` property. By default, it will be `item.id`.
         *
         *
         * For example, given the following graph:
         *
         *     [
         *       {
         *         "label" : "Dashboards",
         *         "id" : "dash",
         *         "children" : [
         *           { "label" : "Truck Statuses", "id" : "trucks" },
         *           { "label" : "Generator Alerts", "id" : "generators" }
         *         ]
         *       },
         *     ]
         *
         * To select the "Truck Statuses" page, set the route array to:
         *
         *     ["dash", "trucks"]
         *
         * If the user then selects the "Generator Alerts" item, the route array
         * would be replaced with a new array with the following entries:
         *
         *     ["dash", "generators"]
         *
         */
        selectedRoute: {
          type: Array,
          notify: true,
          value: function() {
            return [];
          },
          observer: '_assetSelectedByRoute'
        },

        /**
         * [Read-only] The path to the selected item as an array. Begins with
         * the top-most item in the graph and ends with the selected item. It
         * the selected item is at the top of the graph, the array will include
         * only the selected item.
         *
         * If no item is selected, set to null.
         */
        selectedPath: {
          type: Array,
          notify: true,
          readOnly: true,
          value: function() {
            return this.multiSelect ? [] : null;
          }
        },

        /**
         * [Read-only] A reference to the currently selected item's parent. `null`
         * if the selected item has no parent or no item is selected.
         */
        selectedParent: {
          type: Object,
          notify: true,
          readOnly: true,
          value: function() {
            return this.multiSelect ? [] : null;
          }
        },

        /**
         * [Read-only] A reference to the currenty selected item's siblings - the
         * children of its parent. Array with only the selected item if the selected
         * item has no siblings. `null` if no item is selected.
         */
        selectedSiblings: {
          type: Array,
          notify: true,
          readOnly: true,
          value: function() {
            return this.multiSelect ? [] : null;
          }
        },

        /**
         * [Read-only] A reference to the currently selected item's children.
         * Empty array (`[]`) if the selected item has no children. `null` if no
         * item is selected.
         */
        selectedChildren: {
          type: Array,
          notify: true,
          readOnly: true,
          value: function() {
            return this.multiSelect ? [] : null;
          }
        },

        // multiSelect: {
        //   type: Boolean,
        //   value: false,
        //   observer: '_toggleMultiSelect'
        // }
      },

      // _multiSelectChanged(nextVal, lastVal) {
      //   if (nextVal === true && !Array.isArray(this.selected) && this.selected === null) {
      //     this.selected = [];
      //     this.selectedRoute = [];
      //     this.selectedPath = [];
      //     this.selectedParent = [];
      //     this.selectedSiblings = [];
      //     this.selectedChildren = [];
      //   }
      //   if (nextVal === true && !Array.isArray(this.selected) && this.selected !== null) {
      //     this._selectAsset([this.selected], 'MUTLI_CHANGED');
      //   }
      //   if (nextVal === false && Array.isArray(this.selected) && this.selected === null) {
      //     this.selected = null;
      //     this.selectedRoute = [];
      //     this.selectedPath = null;
      //     this.selectedParent = null;
      //     this.selectedSiblings = null;
      //     this.selectedChildren = null;
      //   }
      //   if (nextVal === false && Array.isArray(this.selected) && this.selected !== null) {
      //     this._selectAsset(this.selected[0], 'MUTLI_CHANGED');
      //   }
      // },

      created() {
        this.multiSelect = true;
        this._lastSelection = {
          source: null,
          reason: null,
          item: null
        };
      },

      listeners: {
        'px-app-asset-should-be-selected' : '_assetSelectedByEvent'
      },

      /**
       * Selects an item. Call with an object that is a direct reference to one
       * of the `items` objects.
       *
       * An optional source of the change can be provided as a string.
       */
      select(item, source='METHOD') {
        if (this.multiSelect && typeof item === 'object' && Array.isArray(item)) {
          for (let i=0; i<item.length; i++) {
            this.select(item[i], source);
          }
          return;
        }

        if (!item || (this.multiSelect && this.selected.indexOf(item) > -1)) return;

        if (this._assetGraph.hasNode(item)) {
          return this._selectAsset(item, source);
        } else {
          throw new Error(`The following item could not be found in the items graph:
          ${JSON.stringify(item)}`);
        }
      },

      /**
       * Handles selection from events fired by children. The event `detail.item`
       * should be a reference an item in the asset graph.
       */
      _assetSelectedByEvent(evt) {
        evt.stopPropagation();
        if (evt.detail.item) {
          this._selectAsset(evt.detail.item, 'DOM_EVENT');
        }
      },

      /**
       * Updates the selected item when the `selectedRoute` changes.
       */
      _assetSelectedByRoute(route) {
        if ((route === null && this._lastSelection.route !== null) || (Array.isArray(route) && !route.length && Array.isArray(this._lastSelection.route) && this._lastSelection.route.length > 0)) {
          this._clearSelectedAsset('ROUTE_CHANGED');
          return;
        }
        if (!route || this._lastSelection.route === route) return;

        const item = this._assetGraph.getNodeAtRoute(route);
        if (item) {
          this._selectAsset(item, 'ROUTE_CHANGED');
        } else {
          throw new Error(`The route ${JSON.stringify(route)} could not be found in the items graph.`)
        }
      },

      /**
       * Updates other selected item properties when `selected` changes.
       */
      _assetSelectedByReference(item) {
        if (item === null && this._lastSelection.item !== null) {
          this._clearSelectedAsset('ITEM_CHANGED');
          return;
        }
        if (!item || this._lastSelection.item === item) return;

        if (this._assetGraph.hasNode(item)) {
          this._selectAsset(item, 'ITEM_CHANGED');
        } else {
          throw new Error(`The following item could not be found in the items graph:
          ${JSON.stringify(item)}`)
        }
      },

      /**
       * Gets item metadata from the AssetGraph and updates internaly APIs
       */
      _selectAsset(item, route, source) {
        const {path, route, parent, children, siblings} = this._assetGraph.getNodeInfo(item);

        if (this.multiSelect) {
          if (this.selected.indexOf(item) > -1) {
            this.push('selected', item);
          }
          let index = this.selected.indexOf(item);
          this.push('selectedRoute', route);
          this.push('selectedPath', path);
          this.push('selectedParent', parent);
          this.push('selectedChildren', children);
          this.push('selectedSiblings', siblings);

          let details = {
            index,
            source,
            item,
            route,
            path,
            parent,
            children,
            siblings
          };
        }

        if (!this.multiSelect && this.selected !== item) {
          if (this.selected !== item) {
            this.set('selected', item);
          }
          this.set('selectedRoute', route);
          this._setSelectedPath(path);
          this._setSelectedParent(parent);
          this._setSelectedChildren(children);
          this._setSelectedSiblings(siblings);

          let details = {
            source,
            item,
            route,
            path,
            parent,
            children,
            siblings
          };
        }

        if (details) {
          this.fire('px-app-asset-selected', details);
          return details;
        }
      },
      /**
       * Fired when a new item is selected. Includes details about how the item
       * was selected, and information about the new selected item.
       *
       * The `source` property is a string describing what triggered
       * the selection:
       *
       *   * 'DOM_EVENT' - the user interacted with an item and selected it
       *   * 'ROUTE_CHANGED' - the array bound to `selectedRoute` changed
       *   * 'ITEM_CHANGED' - the object bound to `selected` changed
       *   * 'METHOD' - the `select()` method was called
       *   * 'ROUTE_METHOD' - the `selectRoute()` method was called
       *
       * The event will have the following properties:
       *
       *   * {Object} detail - Contains the event details
       *   * {String} detail.source - Info about the change trigger, see above
       *   * {Object} detail.item - Reference to the selected item
       *   * {Array} detail.route - Route from the top of the graph to the selected item
       *   * {Array} detail.path - Path from the top of the graph to the selected item
       *   * {Object|null} detail.parent - Reference to the selected item's parent, or null if no parent defined
       *   * {Array} detail.children - Reference to the the selected item's children, or an empty array if no children defined
       *   * {Array} detail.siblings - Reference to the the selected item's siblings, or an array with only the selected item if no siblings defined
       *   * {Array} detail.index - If multi-select is enabled, the index of the selected item in the selected array
       *
       * @event px-app-asset-selected
       */

      _deselectAsset(item, route, source) {
        if (!this.multiSelect && (!item || this.selected === item)) {
          let details = {
            source: source,
            item: this.selected,
            route: this.selectedRoute,
            path: this.selectedPath,
            parent: this.selectedParent,
            children: this.selectedChildren,
            siblings: this.selectedSiblings
          };

          this.set('selected', null);
          this.set('selectedRoute', []);
          this._setSelectedPath(null);
          this._setSelectedParent(null);
          this._setSelectedChildren(null);
          this._setSelectedSiblings(null);
        }

        if (this.multiSelect && this.selected.indexOf(item) > -1) {
          let index = this.selected.indexOf(item);
          let details = {
            index: index,
            source: source,
            item: this.selected[index],
            route: this.selectedRoute[index],
            path: this.selectedPath[index],
            parent: this.selectedParent[index],
            children: this.selectedChildren[index],
            siblings: this.selectedSiblings[index]
          };

          this.splice('selected', index, 1);
          this.splice('selectedRoute', index, 1);
          this.splice('selectedPath', index, 1);
          this.splice('selectedParent', index, 1);
          this.splice('selectedChildren', index, 1);
          this.splice('selectedSiblings', index, 1);
        }

        if (details) {
          this.fire('px-app-asset-deselected', details);
          return details;
        }
      },
      /**
       * Fired when the selected item is cleared and no new item is selected.
       *
       * The `source` property is a string describing what triggered
       * the clearing:
       *
       *   * 'DOM_EVENT' - user interaction cleared the selection
       *   * 'ROUTE_CHANGED' - the array bound to `selectedRoute` changed
       *   * 'ITEM_CHANGED' - the object bound to `selected` changed
       *   * 'METHOD' - the `select()` method was called with `null`
       *   * 'ROUTE_METHOD' - the `selectRoute()` method was called with `null` or an empty array
       *
       * @event px-app-asset-selected-cleared
       */

      _removeArrayItem(propName, prop, index, item) {
        this.notifySplices(propName, [{
          index: index,
          removed: item,
          removedCount: 1,
          object: prop,
          type: 'splice'
        }]);
      }
    };
  })();
</script>
