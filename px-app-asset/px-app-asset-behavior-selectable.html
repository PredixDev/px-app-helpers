<script>
  (function() {
    'use strict';

    /* Ensures the behavior namespace is created */
    window.PxAppBehavior = (window.PxAppBehavior || {});

    /**
     *
     *
     * @polymerBehavior PxAppBehavior.AssetSelectable
     */
    PxAppBehavior.AssetSelectable = {
      properties: {
        /**
         * A reference to the currently selected item. Use this property to set the
         * selected item directly. The object passed to this property must be a
         * direct reference to one of the `items` objects. Changing this property
         * will automatically update the `selectedRoute`.
         *
         * See `selectedRoute` for an alternative way to select items.
         */
        selected: {
          type: Object,
          notify: true,
          value: null
        },

        /**
         * The route to the selected item as an array of strings. Use this property
         * to set the selected item by route, or to bind to updates when the
         * selected item is changed. Changing this property will automatically
         * update the `selected` item.
         *
         * The route array starts at the top of the graph and ends with the selected
         * item. Each route entry is a string that corresponds to the unique ID
         * of an item. The item property this unique ID will be taken from can be
         * configured with the `key` property. By default, it will be `item.id`.
         *
         *
         * For example, given the following graph:
         *
         *     [
         *       {
         *         "label" : "Dashboards",
         *         "id" : "dash",
         *         "children" : [
         *           { "label" : "Truck Statuses", "id" : "trucks" },
         *           { "label" : "Generator Alerts", "id" : "generators" }
         *         ]
         *       },
         *     ]
         *
         * To select the "Truck Statuses" page, set the route array to:
         *
         *     ["dash", "trucks"]
         *
         * If the user then selects the "Generator Alerts" item, the route array
         * would be replaced with a new array with the following entries:
         *
         *     ["dash", "generators"]
         *
         */
        selectedRoute: {
          type: Array,
          notify: true,
          observer: '_assetSelectedByRoute'
        },

        /**
         * [Read-only] Helpful metadata about the selected item.
         *
         * SINGLE-SELECT MODE: An object with the following information about
         * the selected item (if no selected item, all values will be null):
         *
         * - {Object} `item`: Reference to the selected item
         * - {Array} `path`: The path to the selected item as an array. Begins with
         * the top-most item in the graph and ends with the selected item. It
         * the selected item is at the top of the graph, the array will include
         * only the selected item.
         * - {Array} `route`: Route to the selected item (see `selectedRoute`
         * for more information on how this is created)
         * - {Object} `parent`: Reference to the selected item's parent,
         * or `null` if it has no parent
         * - {Array} `children`: Reference to the selected item's children,
         * or empty array if it has no children
         * - {Array} `siblings`: Reference to the selected item's siblings (e.g.
         * the children of its parent) or an array with only the selected item
         * if it has no children.
         *
         * MUTLI-SELECT MODE: An array of objects with metadata about each
         * selected item. Each object will be contain the same values as above.
         * If no items are selected, all values will be null.
         */
        selectedMeta: {
          type: Object,
          notify: true,
          readOnly: true,
          value: null,
          computed: '_computeSelectedMeta(selected.*)'
        },

        multiSelect: {
          type: Boolean,
          value: false,
          observer: '_multiSelectChanged'
        }
      },

      created() {
        this._lastSelection = {
          source: null,
          reason: null,
          item: null
        };
      },

      observers: ['_selectedChanged(selected.*)'],

      listeners: {
        'px-app-asset-should-be-selected' : '_assetSelectedByEvent',
        'px-app-asset-should-be-deselected' : '_assetDeselectedByEvent'
      },

      _computeSelectedMeta(selected) {
        if (!this.multiSelect) {
          if (selected.base && this._assetGraph && this._assetGraph.hasNode(selected.base)) {
            const {path, route, parent, children, siblings} = this._assetGraph.getNodeInfo(selected.base);
            return {
              item: selected.base, path, route, parent, children, siblings
            };
          }
        }
        if (this.multiSelect) {
          if (selected.base && Array.isArray(selected.base) && selected.base.length) {
            return selected.base.map(item => {
              const {path, route, parent, children, siblings} = this._assetGraph.getNodeInfo(item);
              return {
                item, path, route, parent, children, siblings
              };
            });
          }
        }
        return {
          item: null, path: null, route: null, parent: null, children: null, siblings: null
        };
      },

      _multiSelectChanged(isMultiSelect) {
        if(isMultiSelect) {
          this.set('selected', []);
          this.set('selectedRoute', []);
        }
      },

      /**
       * Selects an item. Call with an object that is a direct reference to one
       * of the `items` objects. To clear the selected item, call with `null`.
       *
       * An optional source of the change can be provided as a string.
       */
      select(item, source='METHOD') {
        if ((!this.multiSelect && item === null && this._lastSelection.item !== null) ||
            (this.multiSelect && item === null && this.selected.length) ||
            (this.multiSelect && Array.isArray(item) && !item.length && this.selected.length)) {
          this.deselect(Array.isArray(this.selected) ? [...this.selected] : this.selected);
          return this.selected;
        }
        if (!item || (!this.multiSelect && item === this._lastSelection.item) || (this.multiSelect && this.selected.indexOf(item) > -1)) return this.selected;
        if (this.multiSelect && Array.isArray(item) && item.length) {
          for (let i=0; i<item.length; i++) {
            this.select(item[i], source);
          }
          return this.selected;
        }

        if (this._assetGraph.hasNode(item)) {
          return this._selectAsset(item, source);
        } else {
          throw new Error(`The following item could not be found in the items graph:
          ${JSON.stringify(item)}`);
        }
      },

      deselect(item, source='METHOD') {
        if (!this.multiSelect && (!item || this.selected === item)) {
          this._deselectAsset(this.selected);
          return this.selected;
        }
        if (this.multiSelect && !item) {
          this.deselect([...this.selected]);
          return this.selected;
        }
        if (this.multiSelect && Array.isArray(item) && this.selected.length) {
          for (let i=0; i<item.length; i++) {
            this.deselect(item[i], source);
          }
        }
        if (this.multiSelect && item && this.selected.indexOf(item) > -1) {
          this._deselectAsset(item);
        }
      },

      /**
       * Handles selection from events fired by children. The event `detail.item`
       * should be a reference an item in the asset graph.
       */
      _assetSelectedByEvent(evt) {
        evt.stopPropagation();
        if (evt.detail.item) {
          this.select(evt.detail.item, 'DOM_EVENT');
        }
      },

      /**
       * Handles deselection from events fired by children. The event `detail.item`
       * should be a reference an item in the asset graph.
       */
      _assetDeselectedByEvent(evt) {
        evt.stopPropagation();
        if (evt.detail.item) {
          this.deselect(evt.detail.item, 'DOM_EVENT');
        }
      },

      /**
       * Updates the selected item when the `selectedRoute` changes.
       */
      _assetSelectedByRoute(route) {
        // if ((route === null && this._lastSelection.route !== null) || (Array.isArray(route) && !route.length && Array.isArray(this._lastSelection.route) && this._lastSelection.route.length > 0)) {
        //   // this._clearSelectedAsset('ROUTE_CHANGED');
        //   return;
        // }
        // if (!route || this._lastSelection.route === route || (this.multiSelect && Array.isArray(route) && route.length === 0)) return;
        //
        // const item = this._assetGraph.getNodeAtRoute(route);
        // if (item) {
        //   this._selectAsset(item, 'ROUTE_CHANGED');
        // } else {
        //   throw new Error(`The route ${JSON.stringify(route)} could not be found in the items graph.`)
        // }
      },

      /**
       * Updates other selected item properties when `selected` changes.
       */
      _selsectedChanged(ref) {
        if (!ref || !ref.path) return;

        if (!this.multiSelect && ref.path === 'selected') {
          this._updateSelectedRoute(ref.base);
        }

        if (this.multiSelect && (ref.path === 'selected' || ref.path === 'selected.splices')) {
          this._updateSelectedRouteMulti(ref.base);
        }
      },

      _updateSelectedRoute(selected) {
        if (selected) {
          if (!this._assetGraph.hasNode(selected)) {
            throw new Error(`The following item could not be found in the items graph:
              ${JSON.stringify(selected)}`);
            return;
          }

          const route = this._assetGraph.getRouteTo(selected);
          if (this._routeIsDifferent(route, this.selectedRoute)) {
            this.selectedRoute = route;
          }
        }
        else {
          this.selectedRoute = null;
        }
      },

      _updateSelectedRouteMulti(selected) {
        if (selected && Array.isArray(selected) && selected.length) {
          this.selectedRoute = selected.map(item => {
            if (!this._assetGraph.hasNode(item)) {
              throw new Error(`The following item could not be found in the items graph:
                ${JSON.stringify(item)}`);
            }

            return this._assetGraph.getRouteTo(item);
          });
        } else {
          this.selectedRoute = [];
        }
      },

      _routeIsDifferent(r1, r2) {
        if (!r1 || !r2) return true;
        if (r1.length !== r2.length) return true;
        for (let i=0; i<r1.length; i++) {
          if (r1[i] !== r2[i]) return true;
        }
        return false;
      },

      /**
       * Gets item metadata from the AssetGraph and updates internaly APIs
       */
      _selectAsset(item, source) {
        const {path, route, parent, children, siblings} = this._assetGraph.getNodeInfo(item);
        this._lastSelection = {
          item: item,
          source: source,
          route: route
        };
        if(this.multiSelect) {
          this.push('selected', item);
          // this.push('selectedRoute', route);
        }
        else if (this.selected !== item) {
          this.set('selected', item);
          // this.set('selectedRoute', route);
        }

        let details = {
          source,
          item,
          route,
          path,
          parent,
          children,
          siblings
        };

        this.fire('px-app-asset-selected', details);
        return details;
      },
      /**
       * Fired when a new item is selected. Includes details about how the item
       * was selected, and information about the new selected item.
       *
       * The `source` property is a string describing what triggered
       * the selection:
       *
       *   * 'DOM_EVENT' - the user interacted with an item and selected it
       *   * 'ROUTE_CHANGED' - the array bound to `selectedRoute` changed
       *   * 'ITEM_CHANGED' - the object bound to `selected` changed
       *   * 'METHOD' - the `select()` method was called
       *   * 'ROUTE_METHOD' - the `selectRoute()` method was called
       *
       * The event will have the following properties:
       *
       *   * {Object} detail - Contains the event details
       *   * {String} detail.source - Info about the change trigger, see above
       *   * {Object} detail.item - Reference to the selected item
       *   * {Array} detail.route - Route from the top of the graph to the selected item
       *   * {Array} detail.path - Path from the top of the graph to the selected item
       *   * {Object|null} detail.parent - Reference to the selected item's parent, or null if no parent defined
       *   * {Array} detail.children - Reference to the the selected item's children, or an empty array if no children defined
       *   * {Array} detail.siblings - Reference to the the selected item's siblings, or an array with only the selected item if no siblings defined
       *
       * @event px-app-asset-selected
       */

       /**
       * Gets item metadata from the AssetGraph and updates internal APIs
       */
      _deselectAsset(item, source) {
        if (!this.multiSelect) {
          const details = {
            source,
            item: this.selectedItem,
            route: this.selectedRoute,
            path: this.selectedPath,
            parent: this.selectedParent,
            children: this.selectedChildren,
            siblings: this.selectedSiblings
          }
          this.set('selected', null);
          // this.set('selectedRoute', null);
          this.fire('px-app-asset-deselected', details);
        }
        if(this.multiSelect) {
          const {path, route, parent, children, siblings} = this._assetGraph.getNodeInfo(item);
          const details = {
            source,
            item,
            route,
            path,
            parent,
            children,
            siblings
          }
          this.splice('selected', this.selected.indexOf(item), 1);
          // this.splice('selectedRoute', this.selectedRoute.indexOf(route), 1);
          this.fire('px-app-asset-deselected', details);
        }
      },

      /**
       * Fired when a new item is deselected. Includes details about how the item
       * was deselected.
       *
       * The `source` property is a string describing what triggered
       * the selection:
       *
       *   * 'DOM_EVENT' - the user interacted with an item and selected it
       *   * 'ROUTE_CHANGED' - the array bound to `selectedRoute` changed
       *   * 'ITEM_CHANGED' - the object bound to `selected` changed
       *   * 'METHOD' - the `select()` method was called
       *   * 'ROUTE_METHOD' - the `selectRoute()` method was called
       *
       * The event will have the following properties:
       *
       *   * {Object} detail - Contains the event details
       *   * {String} detail.source - Info about the change trigger, see above
       *   * {Object} detail.item - Reference to the selected item
       *   * {Array} detail.route - Route from the top of the graph to the selected item
       *   * {Array} detail.path - Path from the top of the graph to the selected item
       *   * {Object|null} detail.parent - Reference to the selected item's parent, or null if no parent defined
       *   * {Array} detail.children - Reference to the the selected item's children, or an empty array if no children defined
       *   * {Array} detail.siblings - Reference to the the selected item's siblings, or an array with only the selected item if no siblings defined
       *
       * @event px-app-asset-deselected
       */
    };
  })();
</script>
